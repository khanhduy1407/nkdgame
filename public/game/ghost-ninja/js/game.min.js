"use strict";let level,levelNumber,nextLevel,isFinalLevel,isStartLevel,levelExit,loadNextLevel,levelFrame,boss,player,playerData,playerStartPos,speedRunMode,startLevel=0,warpLevel=0,levelTimer=new Timer,endLevelTimer=new Timer,levelMaze=[],levelMazeSize=4,levelColor=new Color,winTimer=new Timer,healthWarning=new Timer,buyTimer=new Timer,mainCanvas=c1,speedRunTime=0,speedRunBestTime=0,coinSoundTimer=new Timer;var timeyear=(new Date).getFullYear();class PlayerData{constructor(){this.health=3,this.healthMax=3,this.boomerangs=1,this.bigBoomerangs=0,this.coins=0}}function Init(){EngineInit(),mainCanvasContext.fillRect(0,0,mainCanvasSize.x,mainCanvasSize.y),Reset(),NextLevel(),EngineUpdate()}function Reset(){playerData=new PlayerData,localStorage.kbap_coins&&(playerData.coins=parseInt(localStorage.kbap_coins,10)),localStorage.kbap_warp&&(warpLevel=parseInt(localStorage.kbap_warp,10)),localStorage.kbap_bestTime&&(speedRunBestTime=parseInt(localStorage.kbap_bestTime,10)),nextLevel=startLevel}function NextLevel(){levelFrame=0,levelNumber=nextLevel,nextLevel=(nextLevel+1)%100,!speedRunMode&&levelNumber>warpLevel&&(warpLevel=levelNumber),localStorage.kbap_warp=warpLevel,isFinalLevel=100==levelNumber,(isStartLevel=!levelNumber)&&(speedRunMode=0),InitLevel()}function InitLevel(){levelTimer.Set(),winTimer.UnSet(),endLevelTimer.UnSet(),cameraScale=2,levelExit=0,boss=0,StartTransiton(),ClearGameObjects(),playerData.boomerangs||playerData.bigBoomerangs||(playerData.boomerangs=1),GenerateLevel(),player=new Player(playerStartPos)}function SpawnPickups(e,t=1,i=1){if(!(Rand()>t))for(let t=0;t<i;++t){let a=new Pickup(e.Clone(),RandInt(8)?RandInt(20)?3:4:RandInt(4)?0:1);i>1&&(a.velocity=RandVector(.1+.03*Clamp(t,3,30)*Rand()))}}function DestroyLevelObject(e,t=1){let i=level.GetDataFromPos(e);if(!i.IsSolid())return 0;let a=1,s=i.object;if(1==s||2==s){if(level.GetDataFromPos(e).object=0,level.DrawTileData(e.x,e.y),SpawnPickups(e,.05),1==s)PlaySound(5),level.DrawEllipse(e,RandBetween(.1,.15),RGBA(0,0,0,RandBetween(.3,.6))),a=0;else{PlaySound(14);for(let t=9;t--;)level.DrawEllipse(e.Clone().Add(RandVector(.2)),RandBetween(.1,.2),RGBA(.2,.1,.05,RandBetween(.3,.6)));a=t}new ParticleEmitter(e,.5,.1,1==s?new Color(.4,.8,.1,1):new Color(.4,.2,.1,1),1==s?new Color(0,.1,0,1):new Color(0,0,0,1))}return a}function Update(){if(++levelFrame,UpdateAudio(),speedRunMode||(localStorage.kbap_coins=playerData.coins),paused||winTimer.IsSet()||player.IsDead()||(speedRunTime+=timeDelta),(player.IsDead()||winTimer.IsSet())&&KeyWasPressed(27)&&(loadNextLevel=2),endLevelTimer.IsSet()&&endLevelTimer.Elapsed()&&(loadNextLevel=1),debug&&KeyWasPressed(78)&&(loadNextLevel=1),isFinalLevel&&(cameraScale=Max(cameraScale-.001,1)),isStartLevel){let e=new Vector2(8,3.7),t=levelTimer.Get(),i=Percent(t,0,3.3),a=Math.abs(3-4*i)/1.7,s=`hsla(${99*t},99%,50%)`;level.DrawText("GHOST",e.Clone().AddXY(0,-a),33*i,"center",2,"#000",s),level.DrawText("NINJA",e.Clone().AddXY(0,a+1.2),33*i,"center",2,"#000",s),200==levelFrame&&level.DrawText("Created by NKDuy",new Vector2(8,9.5),14),260==levelFrame&&level.DrawText("Â© "+timeyear+" NKDuy.",new Vector2(8,10.5),14),320==levelFrame&&level.DrawText("All Rights Reserved.",new Vector2(8,11.5),14)}}function PreRender(){if(cameraPos.Copy(player.pos),mainCanvasContext.fillStyle=levelColor.RGBA(),mainCanvasContext.fillRect(0,0,mainCanvasSize.x,mainCanvasSize.y),isStartLevel){mainCanvasContext.fillStyle="#999";for(let e=2e3;e--;)mainCanvasContext.fillRect((1e9*Math.sin(e)-time*(e+1e3)/50)%(mainCanvas.width+9)-9,9*e%mainCanvas.height,e%7,e%7)}level.Render()}function PostRender(){loadNextLevel&&(2==loadNextLevel&&Reset(),loadNextLevel=0,NextLevel()),UpdateTransiton();let e="";paused&&(e="-Pause-"),winTimer.IsSet()&&(e="You Win!"),player.IsDead()&&(e="Game Over!",DrawText('Press "ESC"',mainCanvasSize.x/2,mainCanvasSize.y/2+80,42)),DrawText(e,mainCanvasSize.x/2,mainCanvasSize.y/2-80,72,"center",2);{let e=16,t=e;for(let i=0;i<player.healthMax;i++){let a=1,s=e;healthWarning.Get()<.5&&(s*=1+.2*Math.sin(2*PI*healthWarning.Get()/.5)),player.health>i&&(a=player.health-i>=1?3:2),DrawScreenTile(e+2*e*i,t,s,a,5)}if(t+=2*e,DrawScreenTile(e,t,e,0,5),DrawText(playerData.boomerangs,34,t+2,32,"left"),playerData.bigBoomerangs&&(DrawScreenTile(e+60,t,e,7,5),DrawText(playerData.bigBoomerangs,94,t+2,32,"left")),t+=2*e,DrawScreenTile(e,5*e,e,5,5),DrawText(playerData.coins,34,t+2,32,"left"),speedRunMode){let e=player.IsDead()||winTimer.IsSet()?"#F00":"#000";DrawText(FormatTime(speedRunTime),mainCanvas.width/2,28,40,"center",1,e)}RenderMap()}mainCanvas.style.cursor="none";let t=0|mousePos.x,i=0|mousePos.y;mainCanvasContext.globalCompositeOperation="difference",mainCanvasContext.fillStyle="#FFF",mainCanvasContext.fillRect(t-2,i-15,4,30),mainCanvasContext.fillRect(t-15,i-2,30,4),mainCanvasContext.globalCompositeOperation="source-over"}function MazeDataPos(e){let t=levelMazeSize/levelSize;return(0|(e=e.Clone(t)).x)+(0|e.y)*levelMazeSize}function RenderMap(){if((isStartLevel||isFinalLevel)&&!debug)return;let e=16,t=24,i=mainCanvasSize.x-levelMazeSize*t-10;e+=32,isStartLevel||DrawText("L-"+levelNumber,i-10,24,32,"right"),levelMaze[MazeDataPos(player.pos)]&&(levelMaze[MazeDataPos(player.pos)]=-1);let a=levelSize/levelMazeSize,s=player.pos.x/a|0,l=player.pos.y/a|0;mainCanvasContext.strokeStyle="#000",mainCanvasContext.lineWidth=2,mainCanvasContext.strokeRect(i,10,t*levelMazeSize,t*levelMazeSize);for(let e=levelMazeSize;e--;)for(let a=levelMazeSize;a--;){let n=levelMaze[a+e*levelMazeSize],r="#0004";n>0&&(r="#333"),-1==n&&(r="#FFF"),a==s&&e==l&&(r="#F00"),mainCanvasContext.fillStyle=r,mainCanvasContext.fillRect(i+a*t,10+e*t,t,t),n&&mainCanvasContext.strokeRect(i+a*t,10+e*t,t,t)}gameObjects.forEach(e=>{let s=e.radarSize;if(s&&levelMaze[MazeDataPos(e.pos)]<0){let l=e.pos.Clone(t/a).AddXY(i,10).Round();mainCanvasContext.fillStyle=e==player?"#FFF":"#000",mainCanvasContext.fillRect(l.x-s-1,l.y-s-1,2*s+2,2*s+2),mainCanvasContext.fillStyle=e==player?"#000":e.isEnemy?"#F00":"#FFF",mainCanvasContext.fillRect(l.x-s,l.y-s,2*s,2*s)}})}class MyGameObject extends GameObject{constructor(e,t=0,i=0,a=.5,s=0,l=1){super(e,t,i,a,s,l),this.walkFrame=0,this.rotation=1,this.radarSize=1,this.isInvisible=0,this.bloodColor=new Color(.8,0,.05,.5),this.bloodAdditive=0}UpdateWalk(){let e=this.walkFrame;if(this.walkFrame+=1.5*this.velocity.Length(),e%2<1&&this.walkFrame%2>1||this.walkFrame%2<e%2){let t=this.IsOnSand(),i=this.rotation*PI/2,a=this.walkFrame%2<e%2?1:-1,s=new Vector2(0,a/8).Rotate(i),l=this.pos.Clone().Add(s),n=t?"#4215":"#2223",r=new Vector2(.2,t?.2:.1);t&&(r.y*=RandBetween(1,1.5),r.x*=RandBetween(1,1.5)),l.y+=.3,level.DrawEllipse(l,r,n,i)}}BloodSplat(e=1,t=1){this.bloodAdditive&&(levelCanvasContext.globalCompositeOperation="screen");for(let t=30;t--;){let t=this.pos.Clone().Add(RandVector(Rand(e*this.size.x))),i=new Vector2(this.size.x*RandBetween(.2,.5),this.size.y*RandBetween(.2,.5)),a=RandBetween(0,2*PI);level.DrawEllipse(t,i.Multiply(e),this.bloodColor.RGBA(),a)}if(levelCanvasContext.globalCompositeOperation="source-over",t){let t=e*this.size.x;new ParticleEmitter(this.pos,.6*t,.2*t,this.bloodColor.Clone().SetAlpha(1),this.bloodColor.Clone(this.bloodAdditive?3:.5).SetAlpha(1))}}Kill(){this.BloodSplat(),PlaySound(9),super.Kill()}Render(){!this.isInvisible||shadowRenderPass||hitRenderPass||(mainCanvasContext.globalAlpha=.1+this.GetDamageFlashPercent()),super.Render()}IsOnSand(){return 2==level.GetDataFromPos(this.pos).type}}class Player extends MyGameObject{constructor(e){super(e,0,4,.5,.4,playerData.healthMax),this.health=playerData.health,this.dashTimer=new Timer,this.throwTimer=new Timer,this.inputTimer=new Timer,this.playerDamageTimer=new Timer,this.inputTimer.Set(),this.throwRotation=0,this.posBuffer=[],this.dashWaitTime=3,this.radarSize=2}IsDashing(){return!this.dashTimer.Elapsed()}CollideLevel(e,t){return this.IsDashing()?DestroyLevelObject(t):super.CollideLevel(e,t)}IsIntro(){return levelTimer.Get()<1.5}Update(){if(playerData.health=this.health,this.IsDead()||endLevelTimer.IsSet()||this.IsIntro())return;if(this.health<=1&&healthWarning.Get()>this.health&&(healthWarning.Set(),PlaySound(11)),MouseWasPressed()&&(playerData.boomerangs||playerData.bigBoomerangs)){let e=0;playerData.bigBoomerangs?(--playerData.bigBoomerangs,e=1):--playerData.boomerangs;let t=new Boomerang(this.pos,e);this.throwRotation=t.Throw(this,mousePosWorld),this.throwTimer.Set(.4)}let e=new Vector2;KeyIsDown(65)&&(e.x-=1,this.rotation=0),KeyIsDown(68)&&(e.x+=1,this.rotation=2),KeyIsDown(87)&&(e.y-=1,this.rotation=3),KeyIsDown(83)&&(e.y+=1,this.rotation=1);let t=this.IsOnSand();this.IsDashing()?(e.x||e.y||e.Set(-1,0).Rotate(-this.rotation*PI/2),this.damageTimer.Set(),t=0,frame%3==0&&this.posBuffer.push(this.pos.Clone()),this.posBuffer.length>20&&this.posBuffer.shift()):(this.posBuffer=[],this.dashTimer.IsSet()&&this.dashTimer.Get()>this.dashWaitTime&&(this.dashTimer.UnSet(),PlaySound(16)),!KeyWasPressed(32)&&!KeyWasPressed(16)||this.dashTimer.IsSet()||(PlaySound(12),this.dashTimer.Set(.5))),(e.x||e.y)&&(e.Normalize(.016*(t?.5:1)),this.IsDashing()&&e.Multiply(2),this.velocity.Add(e),this.inputTimer.Set()),this.inputTimer.Get()>1&&(this.walkFrame=0),this.throwTimer.Elapsed()&&!this.IsDashing()&&this.UpdateWalk(),super.Update()}Render(){if(endLevelTimer.IsSet())return;if(this.IsDead()||this.IsIntro()&&isStartLevel)return this.tileX=7,this.tileY=3,void super.Render();this.tileY=4,1&this.rotation?(this.tileX=1==this.rotation?2:3,this.mirror=this.walkFrame%2|0,this.throwTimer.Elapsed()&&this.dashTimer.Elapsed()?this.inputTimer.Get()>1&&1==this.rotation&&(this.tileX=7,this.mirror=1&(this.inputTimer.Get()/2|0)):this.tileX+=3):(this.mirror=2!=this.rotation,this.tileX=this.walkFrame%2|0,this.throwTimer.Elapsed()&&this.dashTimer.Elapsed()||(this.tileX=4));let e=hitRenderPass;if(this.throwTimer.Elapsed()||(this.rotation=this.throwRotation,1&this.rotation&&(this.mirror=1==this.rotation)),!shadowRenderPass&&e){mainCanvasContext.globalCompositeOperation="screen";for(let t=this.posBuffer.length;t--;)hitRenderPass=e*(t/this.posBuffer.length+.01),DrawTile(this.posBuffer[t],this.size,this.tileX,this.tileY,this.angle,this.mirror,this.height);hitRenderPass=e,mainCanvasContext.globalCompositeOperation="difference"}let t=this.dashTimer.Get();if(!shadowRenderPass&&t<this.dashWaitTime+.5&&(hitRenderPass=t<this.dashWaitTime?t/this.dashWaitTime:Math.sin((t-this.dashWaitTime)*PI*4),DrawTile(this.pos,this.size.Clone(1.1),this.tileX,this.tileY,this.angle,this.mirror,this.height),hitRenderPass=e),super.Render(),playerData.boomerangs||playerData.bigBoomerangs){let e=playerData.bigBoomerangs?7:0;3==this.rotation&&DrawTile(this.pos,this.size,e,5),this.rotation%2==0&&DrawTile(this.pos.Clone().AddXY(.2*-(this.rotation-1),0),this.size.Clone(new Vector2(.6,1)),e,5)}}Damage(e){if(!this.playerDamageTimer.Elapsed())return 0;if(godMode||endLevelTimer.IsSet()||this.IsIntro()||winTimer.IsSet())return 0;let t=super.Damage(e);return t?(this.BloodSplat(),PlaySound(1),this.playerDamageTimer.Set(1),t):0}Kill(){this.BloodSplat(2),PlaySound(2)}}class Boomerang extends MyGameObject{constructor(e,t=0){super(e,t?7:0,5,.5,t?.45:.4),this.damping=.98,this.angle=0,this.canDamageLevel=1,this.heldPickup=0,this.throwAccel=0,this.throwFrames=0,this.bounceObject=0,this.isBig=t}Throw(e,t){return PlaySound(7),this.throwFrames=this.isBig?9:8,this.throwAccel=t.Clone().Subtract(e.pos),this.throwAccel.Normalize(.04),this.angleVelocity=.5,this.height=this.angleVelocity/2,this.velocity=e.velocity.Clone(),this.throwAccel.Rotation()}CollideLevel(e,t){return e.object&&this.damageTimer.Set(),DestroyLevelObject(t,!this.isBig)}Update(){if(this.throwFrames&&this.throwFrames--,this.angleVelocity){endLevelTimer.IsSet()&&endLevelTimer.Set(1);this.GetLifeTime();if(mouseIsDown&&this.throwFrames?this.throwAccel&&this.velocity.Add(this.throwAccel):this.throwAccel=0,this.angleVelocity-=.002,this.angleVelocity<.1&&(this.angleVelocity-=.005,this.velocity.Multiply(.8),this.angleVelocity<0&&(this.angleVelocity=0)),this.height=this.angleVelocity/2,!this.throwAccel&&this.height>0){let e=player.pos.Clone();e.Subtract(this.pos).Multiply(.004*this.angleVelocity),this.velocity.Add(e)}gameObjects.forEach(e=>{!this.isBig&&e.isSmallPickup&&e.GetLifeTime()>.5&&!e.isHeld&&!this.heldPickup&&e.IsTouching(this)?(e.isHeld=1,this.heldPickup=e):(e.isEnemy||e.isStore)&&e.IsTouching(this)&&(this.bounceObject==e||e.ReflectDamage(this.velocity)?this.bounceObject!=e&&(PlaySound(15),this.bounceObject=e,this.velocity.Multiply(-.4),this.angleVelocity*=.4,this.damageTimer.Set(),this.throwAccel=0):e.Damage(1+this.isBig)&&(isStartLevel||e.velocity.Add(this.velocity.Clone(.5)),this.damageTimer.Set()))})}else this.radarSize=3,this.damageFlashTime=.8,this.differenceFlash=0,this.heldPickup&&(this.heldPickup.isHeld=0),this.heldPickup=0,Rand()<.005&&this.damageTimer.Get()>4*this.damageFlashTime&&this.damageTimer.Set(-this.damageFlashTime/2);(!this.angleVelocity||this.GetLifeTime()>.5)&&!player.IsDead()&&player.Distance(this)<.6&&this.Pickup(),super.Update(),this.heldPickup&&this.heldPickup.pos.Copy(this.pos).AddXY(0,-.001)}Pickup(){PlaySound(6),this.isBig?playerData.bigBoomerangs++:playerData.boomerangs++,player.throwTimer.Set(.3),player.throwRotation=this.pos.Clone().Subtract(player.pos).Rotation(),this.Destroy()}}class Pickup extends MyGameObject{constructor(e,t=0){super(e,2+t,5,.5,.3),this.type=t,this.timeOffset=Rand(9),this.isSmallPickup=2!=t,this.isHeld=0,this.differenceFlash=0,this.damageFlashTime=.8,this.radarSize=this.isSmallPickup?1:3}Update(){Rand()<.005&&this.damageTimer.Get()>4*this.damageFlashTime&&this.damageTimer.Set(-this.damageFlashTime/2),this.height=.1+.1*Math.sin(2*time+this.timeOffset),!player.IsDead()&&player.IsTouching(this)?this.Pickup():boss&&boss.IsTouching(this)&&(PlaySound(14),this.Destroy()),super.Update()}Pickup(){2==this.type?(++playerData.healthMax,player.healthMax=playerData.healthMax,player.Heal(1),PlaySound(4)):3==this.type?(PlaySound(10),++playerData.coins):4==this.type?(PlaySound(10),playerData.coins+=5):(player.Heal(.5+this.type/2),PlaySound(3)),this.Destroy()}}class Enemy extends MyGameObject{constructor(e,t=0,i=0,a=.5,s=0,l=1,n=0){super(e,t,i,a,s,l),this.isEnemy=1,this.spawnPickup=1,this.bloodAdditive=1,this.isBig=n,this.radarSize=n?2:1}Damage(e){let t=super.Damage(e);return t&&!this.IsDead()&&(this.BloodSplat(.5),PlaySound(8)),t}Update(){if(player.IsTouching(this)&&player.Damage(.5)){let e=player.pos.Clone();e.Subtract(this.pos).Normalize(.1),player.velocity.Add(e)}super.Update()}Kill(){super.Kill(),levelExit||isFinalLevel||player.IsDead()||gameObjects.some(e=>e.isEnemy)||(levelExit=new LevelExit(this.pos),this.isBig||(this.spawnPickup=0));let e=1;this.isBig&&(e=RandIntBetween(3,5)),this.isInvisible&&(e*=2),SpawnPickups(this.pos,this.spawnPickup,e)}}class SlimeEnemy extends Enemy{constructor(e,t,i=1){let a=.25*t;super(e,5+i,0,a,.8*a,t*i,t>3),this.bloodColor=i>1?new Color(1,0,.5,.5):new Color(0,.5,1,.5),this.randMoveTimer=new Timer,this.randAccel=new Vector2,this.spawnPickup=1==t?i/2:0,this.difficulty=i,this.healthLevel=t,this.baseSize=a,this.damping=.9}Update(){let e=player.pos.Distance(this.pos);if(e>20)return;levelCanvasContext.globalCompositeOperation="screen";let t=this.bloodColor.Clone().SetAlpha(.05).RGBA();level.DrawEllipse(this.pos,new Vector2(.6,.4).Multiply(this.size),t),levelCanvasContext.globalCompositeOperation="source-over",this.randMoveTimer.Elapsed()&&(this.randMoveTimer.Set(RandBetween(.5,1)),this.randAccel=RandVector(1.3));let i=new Vector2;!player.IsDead()&&e<15&&i.Copy(player.pos).Subtract(this.pos).Normalize(),i.Add(this.randAccel).Multiply(this.difficulty>1?.004:.003).Multiply(this.IsOnSand()?.5:1),this.velocity.Add(i);let a=Math.sin(10*this.GetLifeTime()),s=.9+.1*(1-a),l=.9+.1*a;this.size.Set(this.baseSize*s,this.baseSize*l),super.Update()}Kill(){if(this.healthLevel>1)for(let e=2;e--;){let e=new SlimeEnemy(this.pos,this.healthLevel-1,this.difficulty);e.damageTimer.Set(),e.isInvisible=this.isInvisible,e.velocity=this.velocity.Clone()}super.Kill()}}class JumpingEnemy extends Enemy{constructor(e,t=0){super(e,2,2,t?1:.5,t?.8:.4,t?12:4,t),this.landTimer=new Timer,this.jumpWaitTimer=new Timer,this.jumpWaitTimer.Set(RandBetween(1,3)),this.zVelocity=0,this.randOffset=new Vector2,this.bloodColor=new Color(1,.5,0,.1),this.speed=t?.012:.01}Update(){let e=player.pos.Distance(this.pos);if(!(e>20)){if(this.jumpWaitTimer.Elapsed()&&this.height<=0&&(this.zVelocity=RandBetween(.15,.2),this.isBig&&(this.zVelocity*=1.2),this.jumpWaitTimer.Set(RandBetween(1.5,3)),this.randOffset=RandVector(RandBetween(0,1)),this.landTimer.UnSet()),this.height+=this.zVelocity,this.zVelocity-=.005,this.height<=0)this.landTimer.IsSet()||(this.landTimer.Set(.3),this.BloodSplat(.8,0)),this.height=this.zVelocity=0;else{let t=new Vector2;!player.IsDead()&&e<15?t.Copy(player.pos).Subtract(this.pos).ClampLength(1).Add(this.randOffset):t.Copy(this.randOffset),this.velocity.Add(t.Multiply(this.speed))}this.tileX=2,(this.jumpWaitTimer.Get()>-.25||!this.landTimer.Elapsed())&&++this.tileX,super.Update()}}}class ShieldEnemy extends Enemy{constructor(e,t=0,i=0){super(e,4,2,i?1:.5,i?.8:.4,t?50:i?6:2,i),this.moveTimer=new Timer,this.dashTimer=new Timer,this.damping=.8,this.bumped=0,this.type=t,this.moveBackwards=0,this.speed=i?.015:.012,t?(boss=this,this.speed=.018,this.bloodAdditive=0):this.bloodColor=new Color(.3,1,0,.5),this.bossIntro=this.type&&!isStartLevel}ReflectDamage(e){if(this.damageTimer.Get()<.5)return 0;let t=new Vector2(1,0).Rotate(this.rotation*PI/2),i=e.Clone().Normalize().DotProduct(t);return this.type?i>.4:i<-.4}CollideLevel(e,t){let i=!this.isBig&&!this.type;return e.IsSolid()&&(i&&this.dashTimer.Elapsed()&&(this.rotation=(this.rotation+2)%4),this.velocity.Multiply(0)),DestroyLevelObject(t,!this.type)}Damage(e){return this.type&&player.IsDead()?0:super.Damage(e)}Update(){let e=this.GetLifeTime(),t=!this.type&&this.IsOnSand(),i=player.pos.Distance(this.pos);if(this.type&&isStartLevel){let e=this.pos.x-levelExit.pos.x;this.rotation=Math.abs(e)<.5?1:0,this.Distance(levelExit)<1&&this.Destroy()}else if(this.bossIntro)this.pos.x>24?(this.pos.x=24,this.rotation=3):this.rotation=0;else{if(i>20&&!this.type)return;if(this.moveTimer.Elapsed()&&this.dashTimer.Elapsed()){if(this.moveBackwards=0,!player.IsDead()&&(i<15||this.type)){let e=player.pos.Clone().Subtract(this.pos).Rotation();1&e||(e=(e+2)%4),this.rotation=e,this.type&&(this.moveBackwards=Rand()<.5),this.moveBackwards&&(this.rotation=(this.rotation+2)%4),Rand()<.2&&this.dashTimer.Set(2)}else this.rotation=RandInt(4);this.moveTimer.Set(RandBetween(.8,2))}}let a=new Vector2(this.speed*(t?.5:1),0).Rotate(this.rotation*PI/2);this.dashTimer.Elapsed()||a.Multiply(this.dashTimer.Get()<-1?0:2),this.type&&isStartLevel?i>10.5&&a.Multiply(0):this.type&&((e>10&&this.health<this.healthMax||e>20&&i<10)&&(this.bossIntro=0),this.bossIntro?(i>14&&a.Multiply(0),this.pos.y<21&&(a.Multiply(0),this.rotation=1,this.walkFrame+=.021)):(this.bossIntro=0,this.size.x<2?(this.size.AddXY(.005,.005),this.collisionSize=.8*this.size.x,a.Multiply(0),this.walkFrame+=.1,frame%10==0&&(this.rotation=(this.rotation+1)%4),a.Multiply(0)):this.size.Set(2,2))),this.velocity.Add(a.Multiply(this.moveBackwards?-1:1)),1&this.rotation?(this.tileX=1==this.rotation?6:7,this.mirror=this.walkFrame%2|0):(this.mirror=this.rotation,this.tileX=4+(this.walkFrame%2|0)),this.type&&(this.tileY=3,this.tileX-=2),this.UpdateWalk(),super.Update()}Kill(){super.Kill(),this.type&&(boss=0,isFinalLevel&&(new Pickup(this.pos,2),SpawnPickups(this.pos,1,40),winTimer.Set(),localStorage.kbap_warp=0,localStorage.kbap_won=1,speedRunTime|=0,speedRunMode&&(!speedRunBestTime||speedRunTime<speedRunBestTime)&&(speedRunBestTime=speedRunTime,localStorage.kbap_bestTime=speedRunBestTime),PlaySound(2)))}}class Store extends MyGameObject{constructor(e){super(e,7,1,.5,.5),this.count=isStartLevel||isFinalLevel?3:2+RandInt(2);let t=1-this.count;for(let i=this.count;i--;){let a=RandInt(4);isStartLevel||isFinalLevel?a=i+1:0==i?a=RandIntBetween(0,1):1==i&&(a=RandIntBetween(2,3)),new StoreItem(e.Clone().AddXY(2*i+t,0),a,this)}this.pos.y-=2,this.isStore=1,level.FillCircleType(e,3,1),level.FillCircleObject(e,5,0)}Kill(){SpawnPickups(this.pos),super.Kill()}Update(){if(this.GetLifeTime()<.1){let e=this.pos.Clone().AddXY(0,2).Multiply(tileSize),t=16*this.count;levelCanvasContext.fillStyle="#CCC",levelCanvasContext.fillRect(e.x-t-2,e.y-30-2,2*t+4,44),levelCanvasContext.fillStyle="#329",levelCanvasContext.fillRect(e.x-t,e.y-30,2*t,40)}if(this.mirror=player.pos.x<this.pos.x,!buyTimer.Elapsed()){let e=buyTimer.Get();this.height=-e*(.5-.5*Math.cos(6*PI*e))/2}gameObjects.forEach(e=>{e.isEnemy&&e.IsTouching(this)&&this.Kill()}),super.Update()}}class StoreItem extends MyGameObject{constructor(e,t,i){super(e,t+3,5,.5,.2),this.owner=i,this.type=t,this.cost=5,this.wasTouching=0,1==this.type&&(this.cost=50),2==this.type&&(this.cost=40,this.tileX=0),3==this.type&&(this.cost=90,this.tileX=7),isStartLevel||(this.cost*=RandBetween(.5,1.5)),this.cost=Clamp(this.cost,1,99),this.cost|=0}Update(){!player.IsDead()&&player.IsTouching(this)?(this.wasTouching||this.Pickup(),this.wasTouching=1):this.wasTouching=0,this.owner&&this.owner.IsDead()&&this.Destroy(),super.Update()}Pickup(){if(this.cost>playerData.coins)return PlaySound(15),void this.damageTimer.Set();this.type<2?new Pickup(this.pos,this.type+1).Pickup():new Boomerang(this.pos,3==this.type).Pickup(),buyTimer.Set(1),playerData.coins-=this.cost,this.Destroy()}Render(){shadowRenderPass||hitRenderPass||(SetCanvasTransform(this.pos.Clone().AddXY(0,-1),this.size),DrawText(this.cost,-6,0,14,"left",.5,this.GetDamageTime()<.5?"#F00":"#000"),DrawScreenTile(-10,-1,4,5,5),mainCanvasContext.restore()),super.Render()}}class LevelExit extends MyGameObject{constructor(e,t=0){super(e,0,0,0,.5),this.type=t,this.radarSize=2,this.closeTimer=new Timer,this.pos.y+=.01}Update(){this.height=.1+.1*Math.sin(5*time),this.angleVelocity=.05/(this.size+.1);let e=this.pos.Clone().Subtract(player.pos),t=e.Length(),i=this.size.x;if(1==this.type)60==levelFrame&&PlaySound(13),(i=Max(0,1-levelTimer.Get()/2))<=0&&this.Destroy();else if(this.closeTimer.IsSet())i=-this.closeTimer.Get();else if(this.GetLifeTime()<1){let e=this.GetLifeTime();i=Min(2*e,1)}else!player.IsDead()&&t<3&&player.dashTimer.Elapsed()&&(t<.5?(isStartLevel&&3==this.type&&(speedRunMode=1,speedRunTime=0,playerData=new PlayerData),2==this.type&&(nextLevel=warpLevel),PlaySound(13),endLevelTimer.Set(1),this.closeTimer.Set(1)):player.velocity.Add(e.Normalize(.005/t)));i=Max(0,i),this.size.Set(i,i),super.Update()}Render(){let e;SetCanvasTransform(this.pos,this.size,this.angle,this.height),mainCanvasContext.lineWidth=1;for(let t=19;t--;mainCanvasContext.stroke()){mainCanvasContext.beginPath(),e=`hsla(${9*t+99*time},99%,${shadowRenderPass?0:50}%,${shadowRenderPass?.5:1})`,mainCanvasContext.strokeStyle=e;for(let e=8;e--;){let i=time-e*PI/3+5*Math.sin(t/2+2*time)/19;mainCanvasContext.arc(0,0,t*this.size.x,i,i)}}if(this.type>1&&!shadowRenderPass&&!this.closeTimer.IsSet()){let t=2==this.type?"Warp "+warpLevel:"Speed Run";DrawText(t,0,-24,14,"center",1,e,"#000"),3==this.type&&speedRunBestTime&&DrawText("Best "+FormatTime(speedRunBestTime),0,-36,12,"center",1,e,"#000")}mainCanvasContext.restore()}}function GenerateMaze(e){let t=levelMazeSize,i=[];i.length=t*t,i.fill(0);let a=(e,a,s=1)=>i[e+a*t]=s,s=RandInt(levelMazeSize),l=RandInt(levelMazeSize);if(isStartLevel&&(s=l=0,a(0,0),a(1,0)),isFinalLevel){s=0,l=3,a(0,3),a(1,3),a(2,3),a(1,2);for(let e=4;e--;)for(let t=2;t--;)a(e,t)}if(playerStartPos=new Vector2(s,l),isStartLevel||isFinalLevel)return i;let n=(e,a)=>IsArrayValid(e,a,t)?i[e+a*t]:0,r=(e,t)=>{let i=0;return i+=n(e+1,t),i+=n(e-1,t),i+=n(e,t+1),i+=n(e,t-1)},o=(e,i,a,s)=>!(!IsArrayValid(e+a,i+s,t)||n(e+a,i+s)||n(e+2*a,i+2*s)||n(e+2*a+s,i+2*s+a)||n(e+2*a-s,i+2*s-a)||n(e+a+s,i+s+a)||n(e+a-s,i+s-a)),h=s,d=l;a(h,d);let p=[],m=0;for(let t=0;t<1.5*e;++t){let i=0;if(o(h,d,-1,0)&&++i,o(h,d,1,0)&&++i,o(h,d,0,-1)&&++i,o(h,d,0,1)&&++i,i&&t!=e&&(t<e||Rand()<.5)){let e=0,t=0,s=RandInt(i);o(h,d,-1,0)&&!s--?(e=-1,t=0):o(h,d,1,0)&&!s--?(e=1,t=0):o(h,d,0,-1)&&!s--?(e=0,t=-1):(e=0,t=1),p.push({x:h,y:d}),a(h+=e,d+=t)}else{if(!p.length)break;{r(h,d)<=1?a(h,d,2+m++):Rand()<.5&&playerStartPos.Set(h,d);let e=p.pop();h=e.x,d=e.y}}}return i}function GenerateLevel(){for(levelColor=new Color(Rand(.1),Rand(.1),Rand(.1)),isStartLevel&&(levelColor=new Color(.1,0,.2));!GenerateLevelInternal(););}function GenerateLevelInternal(){level=new Level,ClearGameObjects(),levelMaze=GenerateMaze(levelNumber);for(let e=levelMazeSize;e--;)for(let t=levelMazeSize;t--;){if(!levelMaze[e+t*levelMazeSize])continue;let i=new Vector2(e+.5,t+.5).Multiply(levelSize/levelMazeSize),a=isFinalLevel?12:9;level.FillCircleType(i,a,1);for(let e=RandInt(4);e--;)level.FillCircleType(i.Clone().Add(RandVector(Rand(8))),RandBetween(2,6),1+RandInt(2))}if(playerStartPos.Add(.5).Multiply(levelSize/levelMazeSize),isFinalLevel){levelSize;for(let e=30;e--;)level.FillCircleObject(new Vector2(RandIntBetween(0,64),RandIntBetween(0,50)),RandIntBetween(4,14),1+RandInt(2));level.FillCircleObject(playerStartPos,12,0),level.FillCircleType(playerStartPos.Clone().AddXY(16,-20),12,1),level.FillCircleType(playerStartPos.Clone().AddXY(16,-14),12,1);let e=new Vector2(24,18);level.FillCircleType(e,9,2),level.FillCircleObject(e,10,0),levelCanvasContext.fillStyle="#F00",levelCanvasContext.fillRect(0,0,mainCanvasSize.x,mainCanvasSize.y),levelCanvasContext.drawImage(tileImage,0,0);for(let t=16;t--;)for(let i=16;i--;){let a=levelCanvasContext.getImageData(t+64,i+80,1,1).data;level.GetDataFromPos(e.Clone().AddXY(t-8,i-7)).object=a[1]?2:a[0]?0:1}}else if(isStartLevel)level.FillCircleType(playerStartPos,8,1),level.FillCircleType(playerStartPos.Clone().AddXY(16,0),7,1),level.FillCircleObject(playerStartPos.Clone().AddXY(8,-2),3,1),level.FillCircleObject(playerStartPos.Clone().AddXY(8,2),3,1);else{for(let e=levelMazeSize*levelMazeSize*4;e--;)level.FillCircleObject(new Vector2(RandIntBetween(0,64),RandIntBetween(0,64)),RandIntBetween(1,10),RandInt(3));level.FillCircleObject(playerStartPos,RandBetween(2,5),0);let e=5*levelNumber,t=0;for(;e>0;){if(++t>1e4)return 0;let i=new Vector2(RandBetween(0,levelSize),RandBetween(0,levelSize)),a=levelMaze[MazeDataPos(i)];if(!a||2==a&&levelNumber>1)continue;if(i.Distance(playerStartPos)<15)continue;if(t>500&&level.FillCircleObject(i,2,0),!level.IsAreaClear(i,2))continue;let s,l=0;if(Rand()<.33||levelNumber<=1){let e=RandIntBetween(1,3);Rand()<.1&&levelNumber>5&&(e=4);let t=levelNumber<5||Rand()<.5?1:2;s=new SlimeEnemy(i,e,t),l=t*e}else if(3!=levelNumber&&(Rand()<.5||levelNumber<=2)){let e=Rand()<.1&&levelNumber>3;s=new JumpingEnemy(i,e),l=e?6:2}else{let e=Rand()<.1&&levelNumber>4;s=new ShieldEnemy(i,0,e),l=e?9:3}levelNumber>4&&Rand()<.1&&(s.isInvisible=1,l*=2),e-=l}}if(isStartLevel)new Store(new Vector2(24,3.5)),new ShieldEnemy(playerStartPos.Clone(),1),new Pickup(playerStartPos.Clone().Add(new Vector2(16,0)),2),levelExit=new LevelExit(new Vector2(24,13)),warpLevel>1&&new LevelExit(new Vector2(29.5,8),2),localStorage.kbap_won&&new LevelExit(new Vector2(29.5,13),3);else if(isFinalLevel)new Store(new Vector2(43,47)),new ShieldEnemy(playerStartPos.Clone().Add(new Vector2(.5,0)),1),new Pickup(new Vector2(24,19.5),2);else{for(let e=levelMazeSize;e--;)for(let t=levelMazeSize;t--;){if(2==levelMaze[e+t*levelMazeSize]&&levelNumber>1){let i=new Vector2(e+.5,t+.5).Multiply(levelSize/levelMazeSize);i.Distance(playerStartPos)>30&&Rand()<.3?(Rand()>.5?new Pickup(i,2):new Boomerang(i),level.FillCircleType(i,RandIntBetween(2,4),1),level.FillCircleObject(i,RandIntBetween(3,5),0)):new Store(i)}}new LevelExit(playerStartPos,1)}return level.ClearBorder(),level.ApplyTiling(),level.Redraw(),1}let transitionTimer=new Timer,transitionCanvas=c2,transitionCanvasContext=transitionCanvas.getContext("2d");function StartTransiton(){transitionTimer.Set(),transitionCanvas.width=mainCanvasSize.x,transitionCanvas.height=mainCanvasSize.y,transitionCanvasContext.drawImage(mainCanvas,0,0)}function UpdateTransiton(){let e=transitionTimer.Get();if(e>2)return;mainCanvasContext.save(),mainCanvasContext.beginPath();let t=e*mainCanvasSize.x/2;mainCanvasContext.rect(0,0,mainCanvasSize.x,mainCanvasSize.y),mainCanvasContext.arc(mainCanvasSize.x/2,mainCanvasSize.y/2,t,0,7),mainCanvasContext.clip("evenodd"),mainCanvasContext.drawImage(transitionCanvas,0,0),mainCanvasContext.restore()}let lastNote,zzfx_v=.2,zzfx_x=0,zzfx=(e,t,i,a=1,s=.1,l=0,n=0,r=0,o=0)=>{if(!zzfx_x)return;let h=44100;i*=2*PI/h,i*=1+RandBetween(-t,t),l*=1e3*PI/h**2,s=s*(a=h*a|0)|0,r*=2*PI/h,o*=PI,t=[];for(let h=0,d=0,p=0;p<a;++p)t[p]=e*zzfx_v*Math.cos(h*i*Math.cos(d*r+o))*(p<s?p/s:1-(p-s)/(a-s)),h+=1+RandBetween(-n,n),d+=1+RandBetween(-n,n),i+=l;return e=zzfx_x.createBuffer(1,a,h),i=zzfx_x.createBufferSource(),e.getChannelData(0).set(t),i.buffer=e,i.connect(zzfx_x.destination),i.start(),i},beatTimer=new Timer,beatCount=0;function UpdateAudio(){if(!zzfx_x&&MouseWasPressed()&&soundEnable&&(zzfx_x=new AudioContext),coinSoundTimer.IsSet()&&coinSoundTimer.Elapsed()&&(PlaySound(10,800),coinSoundTimer.UnSet()),!isStartLevel&&!winTimer.IsSet())return;let e=[-5,0,2,4,7,12,-5,-8];beatTimer.Elapsed()&&(++beatCount,beatTimer.Set(.5),!(beatCount>15)||1&beatCount&&!RandInt(2)||(beatCount%8==0&&(lastNote=1),zzfx(.4,0,220*2**(e[lastNote]/12),(RandInt(2)+1)/2,.05,0,.4),lastNote=(lastNote+(RandInt(6)-2)+e.length)%e.length),(beatCount%2==0||18&beatCount||!RandInt(20))&&(beatCount%4==0?zzfx(.3,.2,1e3,.08,.05,.8,21,51):zzfx(.8,.2,150,.04,.002,.1,1,.5,.15)))}function PlaySound(e,t=0){switch(e){case 1:zzfx(1,.1,4504,.3,.1,-30,.5,.5,.33);break;case 2:zzfx(.7,0,500,4,.01,-.2,3,3,0);break;case 3:zzfx(1,0,1504,.3,.17,1.7,.5,.4,.33);break;case 4:zzfx(1,0,805,1.1,.71,.5,1.5,.5);break;case 5:zzfx(.3,.2,370,.2,.1,3.9,13,27,.12);break;case 6:zzfx(1,.1,0,.2,.23,2,.4,.6,.9);break;case 7:zzfx(1,.1,53,.2,.26,0,.1,7.5,.58);break;case 8:zzfx(1,.2,370,.1,.23,4.5,2.8,27.4,.12);break;case 9:zzfx(1,.1,1138,.2,.02,0,4,1.2,.1);break;case 10:coinSoundTimer.IsSet()||coinSoundTimer.Set(.05),zzfx(1,.01,800+t,.2,.05);break;case 11:zzfx(.4,.1,418,.1,.79,5,0,1.9,.74);break;case 12:zzfx(1,.1,319,.4,.08,6.6,3.2,2.6,.59);break;case 13:zzfx(1,.1,7,1,.97,0,.6,21.7,.5);break;case 14:zzfx(.8,.1,70,.1,.23,4.5,2.8,27,.12);break;case 15:zzfx(1,.1,800,.2,.02,-.3);break;case 16:zzfx(1,.1,0,.1,.1,1,.1,100)}}let tileImage=new Image;tileImage.onload=(e=>Init()),tileImage.src="tiles.png";