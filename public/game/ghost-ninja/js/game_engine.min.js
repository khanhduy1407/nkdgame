"use strict";let godMode=0,debug=0,soundEnable=1,debugCollision=0,RGBA=(e=0,t=0,a=0,i=1)=>`rgba(${255*e|0},${255*t|0},${255*a|0},${i})`,PI=Math.PI,Rand=(e=1)=>Math.random()*e,RandInt=e=>0|Rand(e),RandBetween=(e,t)=>e+Rand(t-e),RandIntBetween=(e,t)=>e+RandInt(t-e+1),RandVector=(e=1)=>new Vector2(e,0).Rotate(Rand(2*PI)),RandColorBetween=(e,t)=>e.Clone().Lerp(t,Rand()),IsArrayValid=(e,t,a)=>e>=0&&t>=0&&e<a&&t<a,Min=(e,t)=>e<t?e:t,Max=(e,t)=>e>t?e:t,Clamp=(e,t,a)=>Min(Max(e,t),a),Percent=(e,t,a)=>t==a?0:Clamp((e-t)/(a-t),0,1),Lerp=(e,t,a)=>t+Clamp(e,0,1)*(a-t),FormatTime=e=>{let t=(0|e)%60;return(e/60|0)+":"+(t<10?"0":"")+t};class Timer{constructor(){this.endTime=0}Set(e=0){this.endTime=time+e}Get(){return this.IsSet()?time-this.endTime:1e9}IsSet(){return this.endTime>0}UnSet(){this.endTime=0}Elapsed(){return!this.IsSet()||time>this.endTime}}class Vector2{constructor(e=0,t=0){this.x=e,this.y=t}Copy(e){return this.x=e.x,this.y=e.y,this}Clone(e=1){return new Vector2(this.x,this.y).Multiply(e)}Add(e){return e instanceof Vector2?(this.x+=e.x,this.y+=e.y):(this.x+=e,this.y+=e),this}Subtract(e){return this.x-=e.x,this.y-=e.y,this}Multiply(e){return e instanceof Vector2?(this.x*=e.x,this.y*=e.y):(this.x*=e,this.y*=e),this}Set(e,t){return this.x=e,this.y=t,this}AddXY(e,t){return this.x+=e,this.y+=t,this}Normalize(e=1){let t=this.Length();return t>0?this.Multiply(e/t):this.Set(e,y=0)}ClampLength(e){let t=this.Length();return t>e?this.Multiply(e/t):this}Rotate(e){let t=Math.cos(e),a=Math.sin(e);return this.Set(this.x*t-this.y*a,this.x*a-this.y*t)}Round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}Length(){return Math.hypot(this.x,this.y)}Distance(e){return Math.hypot(this.x-e.x,this.y-e.y)}Angle(){return Math.atan2(this.y,this.x)}Rotation(){return Math.abs(this.x)>Math.abs(this.y)?this.x>0?2:0:this.y>0?1:3}Lerp(e,t){return this.Add(e.Clone().Subtract(this).Multiply(t))}DotProduct(e){return this.x*e.x+this.y*e.y}}class Color{constructor(e=0,t=0,a=0,i=1){this.r=e,this.g=t,this.b=a,this.a=i}Copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this.a=e.a,this}Clone(e=1){return new Color(this.r*e,this.g*e,this.b*e,this.a*e)}Subtract(e){return this.r-=e.r,this.g-=e.g,this.b-=e.b,this.a-=e.a,this}SetAlpha(e){return this.a=e,this}Lerp(e,t){return e.Clone().Subtract(e.Clone().Subtract(this).Clone(1-t))}RGBA(){return RGBA(this.r,this.g,this.b,this.a)}}class GameObject{constructor(e,t,a,i=.5,s=0,n=1){this.pos=e.Clone(),this.tileX=t,this.tileY=a,this.size=new Vector2(i,i),this.collisionSize=s,this.health=n,this.healthMax=n,this.damageTimer=new Timer,this.lifeTimer=new Timer,this.lifeTimer.Set(),this.velocity=new Vector2,this.angle=0,this.angleVelocity=0,this.damping=.8,this.mirror=0,this.height=0,this.damageFlashTime=.5,this.differenceFlash=1,gameObjects.push(this)}Update(){let e=this.pos,t=this.pos.Clone();t.Add(this.velocity);let a=this.collisionSize;if(!level.IsAreaClear(t,a,this)){let i=level.IsAreaClear(new Vector2(t.x,e.y),a),s=level.IsAreaClear(new Vector2(e.x,t.y),a);i&&!s||(t.x=e.x,this.velocity.x*=-.5),s&&!i||(t.y=e.y,this.velocity.y*=-.5)}this.pos=t,this.velocity.Multiply(this.damping),this.angle+=this.angleVelocity,debugCollision&&DebugRect(this.pos,new Vector2(this.collisionSize,this.collisionSize),"#F00")}Render(){DrawTile(this.pos,this.size,this.tileX,this.tileY,this.angle,this.mirror,this.height)}Heal(e){if(this.IsDead())return 0;let t=this.health;return this.health=Min(this.health+e,this.healthMax),this.health-t}Damage(e){if(this.IsDead()||this.GetDamageTime()<.5)return 0;this.damageTimer.Set();let t=this.health;return this.health=Max(this.health-e,0),this.health||this.Kill(),t-this.health}ReflectDamage(e){return 0}GetLifeTime(){return this.lifeTimer.Get()}GetDamageTime(){return this.damageTimer.Get()}GetDamageFlashPercent(){return Clamp(1-this.GetDamageTime()/this.damageFlashTime,0,1)}IsTouching(e){return this.Distance(e)<e.collisionSize+this.collisionSize}IsDead(){return!this.health}Kill(){this.health=0,this.Destroy()}Destroy(){gameObjects.splice(gameObjects.indexOf(this),1)}Distance(e){let t=this.pos,a=e.pos;return Math.hypot(t.x-a.x,t.y-a.y,this.height-e.height)}CollideLevel(e,t){return e.type?this.height>1?0:e.object:1}}let mainCanvasContext,tileMaskCanvas,tileMaskCanvasContext,hitCanvas,hitCanvasContext,levelCanvas,levelCanvasContext,cameraScale=1,cameraPos=new Vector2,frame=0,time=1,paused=0,timeDelta=1/60,shadowRenderPass=0,hitRenderPass=0,mainCanvasSize=new Vector2,tileSize=16,levelSize=64;function EngineInit(){mainCanvasContext=mainCanvas.getContext("2d"),mainCanvasSize.Set(window.innerWidth/2|0,window.innerHeight/2|0),mainCanvas.width=mainCanvasSize.x,mainCanvas.height=mainCanvasSize.y,levelCanvas=document.createElement("canvas"),levelCanvasContext=levelCanvas.getContext("2d"),levelCanvas.display="none",levelCanvasContext.imageSmoothingEnabled=0,tileMaskCanvas=document.createElement("canvas"),tileMaskCanvasContext=tileMaskCanvas.getContext("2d"),tileMaskCanvas.display="none",tileMaskCanvas.width=2*tileImage.width,tileMaskCanvas.height=tileImage.height,tileMaskCanvasContext.fillStyle="#FFF",tileMaskCanvasContext.fillRect(0,0,tileMaskCanvas.width,tileMaskCanvas.height),tileMaskCanvasContext.globalCompositeOperation="destination-atop",tileMaskCanvasContext.drawImage(tileImage,0,0),tileMaskCanvasContext.globalCompositeOperation="source-over",tileMaskCanvasContext.drawImage(tileMaskCanvas,tileImage.width,0),tileMaskCanvasContext.globalCompositeOperation="difference",tileMaskCanvasContext.drawImage(tileMaskCanvas,tileImage.width,0),InitDebug()}function EngineUpdate(){if((paused=!debug&&!document.hasFocus())&&(mouseIsDown=mouseWasDown=0,keyInputData.map(e=>e.wasDown=e.isDown=0)),mainCanvasSize.Set(window.innerWidth/2,window.innerHeight/2),mainCanvas.width=mainCanvasSize.x,mainCanvas.height=mainCanvasSize.y,mainCanvasContext.imageSmoothingEnabled=0,mousePosWorld.Copy(mousePos).Subtract(mainCanvasSize.Clone(.5)).Multiply(1/cameraScale*tileSize).Add(cameraPos),!paused){let e=1;for(debug&&KeyIsDown(107)&&(e=4),debug&&KeyIsDown(109)&&(e=debugFrame%4==0);e--;)time=++frame*timeDelta+1,Update(),UpdateGameObjects()}gameObjects.sort((e,t)=>e.pos.y-t.pos.y),PreRender(),shadowRenderPass=1,RenderGameObjects(),shadowRenderPass=0,RenderGameObjects(),PostRender(),UpdateDebug(),mouseWasDown=mouseIsDown,keyInputData.map(e=>e.wasDown=e.isDown),requestAnimationFrame(EngineUpdate)}let gameObjects=[];function ClearGameObjects(){gameObjects=[]}function UpdateGameObjects(){gameObjects.forEach(e=>e.Update())}function RenderGameObjects(){gameObjects.forEach(e=>{e.Render(),shadowRenderPass||(hitRenderPass=e.GetDamageFlashPercent())&&(e.differenceFlash&&(mainCanvasContext.globalCompositeOperation="difference"),e.Render(),mainCanvasContext.globalCompositeOperation="source-over",hitRenderPass=0)})}let mouseIsDown=0,mouseWasDown=0,keyInputData=[],mousePos=new Vector2,mousePosWorld=new Vector2;function MouseWasPressed(){return mouseIsDown&&!mouseWasDown}function KeyIsDown(e){return keyInputData[e]?keyInputData[e].isDown:0}function KeyWasPressed(e){return KeyIsDown(e)&&!keyInputData[e].wasDown}function ClearInput(){keyInputData.map(e=>e.wasDown=e.isDown=0),mouseIsDown=mouseWasDown=0}oncontextmenu=function(e){e.preventDefault()},onmousedown=function(e){mouseIsDown=1},onmouseup=function(e){mouseIsDown=0},onmousemove=function(e){let t=mainCanvas.getBoundingClientRect();mousePos.Set((e.clientX-t.left)/t.width,(e.clientY-t.top)/t.height).Multiply(mainCanvasSize)},onkeydown=function(e){debug&&192==e.keyCode&&(e.preventDefault(),ToggleDebugConsole()),debug&&document.activeElement&&"textarea"==document.activeElement.type||(keyInputData[e.keyCode]={isDown:1})},onkeyup=function(e){debug&&document.activeElement&&"textarea"==document.activeElement.type||keyInputData[e.keyCode]&&(keyInputData[e.keyCode].isDown=0)};let shadowAlpha=.5,shadowSkew=.7,shadowScale=.7;function DrawScreenTile(e,t,a,i,s){mainCanvasContext.drawImage(tileImage,i*tileSize,s*tileSize,tileSize,tileSize,e-a,t-a,2*a,2*a)}function SetCanvasTransform(e,t,a=0,i=0){mainCanvasContext.save();let s=e.Clone();shadowRenderPass?s.AddXY(-i*shadowSkew/2,-i*shadowScale/2):s.y-=i,s.Subtract(cameraPos).Multiply(tileSize*cameraScale),s.Add(mainCanvasSize.Clone(.5)),mainCanvasContext.translate(0|s.x,0|s.y);let n=t.Clone(tileSize);shadowRenderPass&&mainCanvasContext.transform(1,0,shadowSkew,shadowScale,-shadowSkew*cameraScale*n.x,cameraScale*(1-shadowScale)*n.y),a&&mainCanvasContext.rotate(a),mainCanvasContext.scale(cameraScale,cameraScale)}function DrawTile(e,t,a,i,s=0,n=0,l=0){SetCanvasTransform(e,t,s,l);let o=tileImage;shadowRenderPass?(o=tileMaskCanvas,mainCanvasContext.globalAlpha*=shadowAlpha,a+=tileImage.width/tileSize):hitRenderPass&&(o=tileMaskCanvas,mainCanvasContext.globalAlpha*=hitRenderPass);let r=t.Clone(2*tileSize);mainCanvasContext.scale(n?-r.x:r.x,r.y),mainCanvasContext.drawImage(o,a*tileSize+.25,i*tileSize+.25,tileSize-.5,tileSize-.5,-.5,-.5,1,1),mainCanvasContext.restore(),mainCanvasContext.globalAlpha=1}function DrawText(e,t,a,i,s="center",n=1,l="#000",o="#FFF",r=mainCanvasContext){r.fillStyle=l,r.font=`900 ${i}px arial`,r.textAlign=s,r.textBaseline="middle",r.fillText(e,t,a),n&&(r.lineWidth=n,r.strokeStyle=o,r.strokeText(e,t,a))}class LevelData{constructor(){this.type=0,this.object=0,this.tile=0,this.rotation=0}Clear(){this.type=this.object=0}IsSolid(){return!this.type||this.object}}class Level{constructor(){levelCanvas.height=levelCanvas.width=levelSize*tileSize,this.data=[];for(let e=0;e<levelSize*levelSize;e++)this.data[e]=new LevelData}GetDataFromPos(e){return this.GetData(e.x,e.y)}GetData(e,t){return IsArrayValid(e,t,levelSize)?this.data[(0|e)+(0|t)*levelSize]:new LevelData}IsAreaClear(e,t,a=0){let i=e.y,s=e.x;for(let e=i-t;e<=i+t;){for(let i=s-t;i<=s+t;){let n=new Vector2(Math.floor(i)+.5,Math.floor(e)+.5),l=this.GetDataFromPos(n);if(a){if(a.CollideLevel(l,n))return 0}else if(l.IsSolid())return 0;if(i==s+t)break;++i>s+t&&(i=s+t)}if(e==i+t)break;++e>i+t&&(e=i+t)}return 1}FillCircleObject(e,t,a){this.FillCircleCallback(e,t,e=>e.object=e.type?a:e.object)}FillCircleType(e,t,a){this.FillCircleCallback(e,t,e=>e.type=a)}FillCircleCallback(e,t,a){for(let i=-t;i<=t;i++){let s=(t**2-(i+.5)**2)**.5;for(let t=e.y-s;t<e.y+s;t++){let s=e.x+i|0,n=0|t;IsArrayValid(s,n,levelSize)&&a(this.GetData(s,n))}}}ApplyTiling(){for(let e=0;e<levelSize;e++)for(let t=0;t<levelSize;t++){let a=this.GetData(t,e),i=a.type,s=this.GetData(t+1,e).type==i,n=this.GetData(t-1,e).type==i,l=this.GetData(t,e-1).type==i,o=this.GetData(t,e+1).type==i,r=s+n+l+o,h=8*i,c=0;i<2&&(h+=r,r>=2&&h++,1==r?n?c=1:l?c=2:s&&(c=3):2==r?s&&n?(h--,c=1):l&&o?h--:n&&o?c=1:n&&l?c=2:s&&l&&(c=3):3==r&&(s?o?n||(c=3):c=2:c=1)),a.tile=h,a.rotation=c}for(let e=0;e<levelSize;e++)for(let t=0;t<levelSize;t++){if(Rand()>.05)continue;let a=level.GetData(t,e);13==a.tile&&(a.tile++,a.rotation=RandInt(4)),16==a.tile&&(a.tile+=1,a.rotation=RandInt(4))}}ClearBorder(){let e=levelSize;for(let t=0;t<e;t++)this.GetData(t,0).Clear(),this.GetData(t,e-1).Clear(),this.GetData(0,t).Clear(),this.GetData(e-1,t).Clear()}DrawEllipse(e,t,a="#FFF",i=0){let s=new Vector2(1,1).Multiply(t).Multiply(tileSize);levelCanvasContext.beginPath(),levelCanvasContext.ellipse(e.x*tileSize,e.y*tileSize,s.x,s.y,i,0,7),levelCanvasContext.fillStyle=a,levelCanvasContext.fill()}DrawText(e,t,a,i="center",s=0,n="#000",l="#FFF"){DrawText(e,t.x*tileSize,t.y*tileSize,a,i,s,n,l,levelCanvasContext)}DrawTileData(e,t){e|=0,t|=0;let a=this.GetData(e,t),i=a.tile%8,s=a.tile/8|0,n=new Vector2(e+.5,t+.5);this.DrawTile(n,.5,i,s,a.rotation*PI/2),a.object&&(i=(a.object-1)%8,s=3+((a.object-1)/8|0),this.DrawTile(n,.5,i,s))}DrawTile(e,t,a,i,s=0){let n=t*tileSize;levelCanvasContext.save(),levelCanvasContext.translate(e.x*tileSize,e.y*tileSize),levelCanvasContext.rotate(s),levelCanvasContext.drawImage(tileImage,a*tileSize,i*tileSize,tileSize,tileSize,-n,-n,2*n,2*n),levelCanvasContext.restore()}Redraw(){levelCanvas.width|=0;for(let e=0;e<levelSize;e++)for(let t=0;t<levelSize;t++)this.DrawTileData(t,e)}Render(){let e=cameraPos.Clone(-cameraScale*tileSize).Add(mainCanvasSize.Clone(.5));mainCanvasContext.drawImage(levelCanvas,0|e.x,0|e.y,cameraScale*levelCanvas.width|0,cameraScale*levelCanvas.height|0)}}class Particle{constructor(e,t,a,i,s,n,l){this.emitter=e,this.pos=t,this.velocity=a,this.size=i,this.lifeTime=s,this.startColor=n,this.endColor=l,this.lifeTimer=new Timer,this.lifeTimer.Set()}Update(){this.pos.Add(this.velocity.Multiply(.9)),this.lifeTimer.Get()>this.lifeTime&&this.emitter.particles.splice(this.emitter.particles.indexOf(this),1),debugCollision&&DebugRect(this.pos,new Vector2(this.size,this.size),"#0FF")}Render(){let e=Percent(this.lifeTimer.Get(),0,this.lifeTime),t=this.startColor.Clone().Lerp(this.endColor,e);t.a*=e<.1?e/.1:1,mainCanvasContext.fillStyle=t.RGBA();let a=this.size*cameraScale*tileSize*Lerp(e,1,.5),i=this.pos.Clone().Subtract(cameraPos).Multiply(tileSize*cameraScale).Add(mainCanvasSize.Clone(.5)).Add(-a);mainCanvasContext.fillRect(i.x,i.y,2*a,2*a)}}class ParticleEmitter extends GameObject{constructor(e,t,a,i,s){super(e,0,0,t),this.particleSize=a,this.color1=i.Clone(),this.color2=s.Clone(),this.particles=[],this.emitTimeBuffer=0}Update(){if(this.particles.forEach(e=>e.Update()),this.GetLifeTime()<=.05){let e=.005;for(this.emitTimeBuffer+=timeDelta;this.emitTimeBuffer>e;)this.emitTimeBuffer-=e,this.AddParticle()}else this.particles.length||this.Destroy();debugCollision&&DebugRect(this.pos,new Vector2(this.size,this.size),"#00F"),super.Update()}Render(){this.particles.forEach(e=>e.Render())}AddParticle(){this.particles.push(new Particle(this,this.pos.Clone().Add(RandVector(Rand(this.size.x))),RandVector(Rand(.2)),RandBetween(this.particleSize,2*this.particleSize),RandBetween(.5,1),RandColorBetween(this.color1,this.color2),RandColorBetween(this.color1,this.color2).SetAlpha(0)))}}